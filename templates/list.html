{% extends "base.html" %}
{% block stylesheet %}
<style>
    table.dataTable td {
        font-size: 13px;
    }
    th { font-size: 13px; }
</style>
{% endblock %}

{% block content %}

    <!-- 编辑弹窗 -->
    <div id="editModal" class="modal fade" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑记录</h5>
                </div>
                <div class="modal-body">        
                    <form id="editForm" >
                        <input type="hidden" name="id">
                        <div>
                            <label class="col-form-label">媒体名称:</label>
                            <input type="text" name="media_name" required class="form-control">
                        </div>
                        <div>
                            <label class="col-form-label">分类:</label>
                            <input type="text" name="category" required class="form-control">
                        </div>
                        <div>
                            <label class="col-form-label">TMDB ID:</label>
                            <input type="number" name="tmdb_id" required class="form-control">
                        </div>
                        <div>
                            <label class="col-form-label">年份:</label>
                            <input type="number" name="year" required class="form-control">
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary">
                        取消
                    </button>
                    <button type="submit" class="btn btn-primary" >
                        保存
                    </button>
                </div>
            </div>

        </div>
    </div>


    <div class="table-responsive my-2 mx-1">

        <table id="data" class="display table-striped order-column" style="width:100%">
          <thead>
            <tr>
              <th></th>
              <th>媒体名称</th>
              <th>种子名称</th>
              <th>加入时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      
      
    </div>

{% endblock %} 

{% block script %}
<script>

    var YajraDataTable;
        // 打开编辑弹窗
        function editRecord(ele, id) {
            var tr_el = ele.closest('tr');
            var row = YajraDataTable.row(tr_el);
            var record = row.data();

            // const modal = document.getElementById('editModal');
            const form = document.getElementById('editForm');
            
            // 填充表单数据
            form.elements.id.value = record.id;
            // form.elements.seed_name.value = record.seed_name;
            form.elements.media_name.value = record.media_title;
            form.elements.category.value = record.tmdb_cat;
            form.elements.tmdb_id.value = record.tmdb_id;
            form.elements.year.value = record.year;
            
            // 显示弹窗
            $("#editModal").modal('show');
        }

        // 关闭编辑弹窗
        function closeEditModal() {
            $("#editModal").modal('hide');
        }

        // 处理编辑表单提交
        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const id = data.id;
            delete data.id;
            
            try {
                const response = await fetch(`/api/records/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('更新成功');
                    closeEditModal();
                } else {
                    alert('更新失败：' + result.message);
                }
            } catch (error) {
                alert('更新失败：' + error);
            }
        };

        // 删除记录
        async function deleteRecord(ele, id) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/records/${id}`, {
                    method: 'DELETE',
                });
                
                const result = await response.json();
                if (result.success) {
                    // alert('删除成功');
                    $('#data').DataTable().ajax.reload();
                } else {
                    alert('删除失败：' + result.message);
                }
            } catch (error) {
                alert('删除失败：' + error);
            }
        }

        function convertToLinks(input) {
  // 将输入字符串按逗号分隔为多个部分
  const items = input.split(',').map(item => item.trim());
  let result = '';
  
  items.forEach(item => {
    // 使用正则表达式分隔每一组数据（根据 | 分隔）
    const parts = item.split('|');
    if (parts.length === 2) {
      const text = parts[0].trim();  // 提取文本部分
      const link = parts[1].trim();  // 提取链接部分
      
      // 构造 HTML 链接
      result += `<a href="${link}">${text}</a><br>`;
    }
  });
  
  return result;
}

$(document).ready(function () {
    YajraDataTable = $('#data').DataTable({
      language: DATATABLE_LANG,
      "pageLength": 50,
      autoWidth: false,
      scrollX: true,
      full_row_select: false,
      ajax: '/api/mediadata',
      serverSide: true,
      order: [[0, 'desc']],
      columns: [
      {
          data: 'tmdbcat',
          "width": "5%",
          "render": function (data, type, row, meta) {
            // console.log(row.tmdbposter);
            if (row.poster_path) {
              var s = row.tmdb_cat + '-' + row.tmdb_id;
              return '<a class="preview" title='+row.media_name+' href="https://image.tmdb.org/t/p/w200' + row.poster_path + '" target="_blank"><img src="https://image.tmdb.org/t/p/w45' + row.poster_path + '"></a>';
            }
            else return ''
          }

        },
        {
            data: 'media_title',
            "width": "35%",
            "render": function (data, type, row, meta) {
            if (row.tmdb_id > 0) {
              var tmdb_link = row.tmdb_cat + '/' + row.tmdb_id;
              var tmdb_title = (row.media_title) ? row.media_title : tmdb_link;
              var tmdb_line = row.tmdb_id ? '<a href="https://www.themoviedb.org/' + tmdb_link + '" target="_blank">' + tmdb_title + '</a>' : tmdb_title;
              var genre = '<span class="sub-title">' + row.genre_str + '</span>'
              var tmdbcat = row.tmdb_cat == 'tv' ? '<span class="tag-tv ">'+row.tmdb_cat+'</span>' : '<span class="tag-movie">'+row.tmdb_cat+'</span>';
              var overview = row.overview ? '<span class="sub-title">' + row.overview + '</span>' : '';
              return tmdb_line + genre + '<br>' + tmdbcat +  overview;
            }
            else return ''
          }
        },
        {
            data: 'torname',
            "width": "40%",
            "render": function (data, type, row, meta) {
                if (row.torname) {
                    var r = convertToLinks(row.torname);
                    return r
                }
            }
        },
        {
          data: 'created_at',
          "width": "8%",
          "render": function (data) {
            // https://stackoverflow.com/questions/8362952/javascript-output-current-datetime-in-yyyy-mm-dd-hhmsec-format
            var date = new Date(data);
            return date.toISOString().slice(0, 19).replace(/-/g, "/").replace("T", " ");
          }
        },
        {
          "width": "12%",
          "render": function (data, type, row) {
            // var linkDelete = '<a href="/mediadel/' + row.id + '">删除</a>';
            var linkDelete = '<a href="#" onclick="deleteRecord(this, \'' + row.id + '\');return false;">' + '删除' + '</a>';
            var linkEdit = '<a href="#" onclick="editRecord(this, \'' + row.id + '\');return false;">' + '修正' + '</a>';
            return linkEdit + " | " + linkDelete;
          },
        },
      ],
    });
});

</script>
{% endblock %}